```txt
/*
 * Copyright 2021-2022 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
```


```txt
/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
```
<!-- TOC -->

- [ABACæˆæƒæ¨¡å‹](#abacæˆæƒæ¨¡å‹)
  - [å¸¸ç”¨çš„æˆæƒæ¨¡å‹](#å¸¸ç”¨çš„æˆæƒæ¨¡å‹)
  - [ABACçš„è®¿é—®æ§åˆ¶](#abacçš„è®¿é—®æ§åˆ¶)
  - [è¡¨è¾¾å¼è¯­è¨€](#è¡¨è¾¾å¼è¯­è¨€)
  - [SpELæ€§èƒ½](#spelæ€§èƒ½)
- [ABACå®è·µ](#abacå®è·µ)
  - [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
  - [javaç¨‹åº](#javaç¨‹åº)
    - [crudä»£ç ](#crudä»£ç )
    - [securityä¸Šä¸‹æ–‡](#securityä¸Šä¸‹æ–‡)
  - [æµ‹è¯•ç±»](#æµ‹è¯•ç±»)
- [Spring Security å’Œ Apache Shiroæ•´åˆ](#spring-security-å’Œ-apache-shiroæ•´åˆ)

<!-- /TOC -->


æœ€è¿‘æœ‰ç‚¹æ— èŠï¼Œä»¥è‡³äºæˆ‘å¾ˆå·²ç»å¾ˆä¹…æ²¡æœ‰å†™å‡ºé«˜è´¨é‡çš„åšå®¢ï¼Œä¸ºäº†æŒ½å›è‡ªå·±çš„è¿™ç§æ— èŠæ„Ÿæ‰“ç®—æ‰‹æ’•ä¸€ä¸‹``ABACæ¨¡å‹``ï¼Œæ¯•ç«Ÿ``RBACæ¨¡å‹``äº”å¼ åŸºç¡€è¡¨ç©æ¥ç©å»ä¹Ÿç©ä¸å‡ºæ¥å¤šå°‘ç«èŠ±äº†ï¼Œæ•´ç†ä¸€ä¸‹``ABAC``æ¨¡å‹çš„å®ç°ä¹Ÿè®©è¿™ä¸ªå‘¨æœ«æ›´æœ‰æ„ä¹‰ä¸€ç‚¹ã€‚


ç¬¬ä¸€ç« ABACæˆæƒæ¨¡å‹æ˜¯ä¸ºäº†è®©å¤§å®¶å…ˆç†è§£ä½•ä¸ºABACã€‚   
ç¬¬äºŒç« ABACå®è·µæ˜¯å¯¹ABACæ¨¡å‹çš„ä»£ç å®ç°ã€‚   
ç¬¬ä¸‰ç« ç®€å•çš„æè¿°äº†ä¸€ä¸‹å¦‚ä½•æ•´åˆè¿›Spring Security æˆ–è€… Apache Shiroã€‚


é¡¹ç›®æºç ï¼š[galaxy-sea/galaxy-blogs/code/abac](https://github.com/galaxy-sea/galaxy-blogs/tree/master/code/abac)

# ABACæˆæƒæ¨¡å‹

- [åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰- é˜¿é‡Œäº‘IDaaS](https://help.aliyun.com/document_detail/174235.html)
- [ABAC- ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/abac/3555041?fr=aladdin)

ä¸ªäººè§‰å¾—è¿™ä¸¤ç¯‡æ–‡ç« å·²ç»å®Œç¾æè¿°äº†ABACæ¨¡å‹çš„åŸç†


## å¸¸ç”¨çš„æˆæƒæ¨¡å‹

æ­¤èŠ‚æ‘˜è‡ª[åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰- é˜¿é‡Œäº‘IDaaS](https://help.aliyun.com/document_detail/174235.html)


- ACLï¼ˆAccess Control Listï¼‰ï¼Œåœ¨ACLä¸­ï¼ŒåŒ…å«ç”¨æˆ·ã€èµ„æºã€èµ„æºæ“ä½œ ä¸‰ä¸ªå…³é”®è¦ç´ ã€‚é€šè¿‡å°†èµ„æºä»¥åŠèµ„æºæ“ä½œæˆæƒç»™ç”¨æˆ·è€Œä½¿ç”¨æˆ·è·å–å¯¹èµ„æºè¿›è¡Œæ“ä½œçš„æƒé™ã€‚

- RBACï¼ˆRole-Based Access Control ï¼‰ï¼Œæ˜¯æŠŠç”¨æˆ·æŒ‰è§’è‰²è¿›è¡Œå½’ç±»ï¼Œé€šè¿‡ç”¨æˆ·çš„è§’è‰²æ¥ç¡®å®šç”¨æˆ·èƒ½å¦é’ˆå¯¹æŸé¡¹èµ„æºè¿›è¡ŒæŸé¡¹æ“ä½œã€‚RBACç›¸å¯¹äºACLæœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯å®ƒç®€åŒ–äº†ç”¨æˆ·ä¸æƒé™çš„ç®¡ç†ï¼Œé€šè¿‡å¯¹ç”¨æˆ·è¿›è¡Œåˆ†ç±»ï¼Œä½¿å¾—è§’è‰²ä¸æƒé™å…³è”èµ·æ¥ï¼Œè€Œç”¨æˆ·ä¸æƒé™å˜æˆäº†é—´æ¥å…³è”ã€‚

- ABACï¼ˆAttribute Base Access Controlï¼‰ åŸºäºå±æ€§çš„æƒé™æ§åˆ¶ä¸åŒäºå¸¸è§çš„å°†ç”¨æˆ·é€šè¿‡æŸç§æ–¹å¼å…³è”åˆ°æƒé™çš„æ–¹å¼ï¼ŒABACåˆ™æ˜¯é€šè¿‡åŠ¨æ€è®¡ç®—ä¸€ä¸ªæˆ–ä¸€ç»„å±æ€§æ¥æ˜¯å¦æ»¡è¶³æŸç§æ¡ä»¶æ¥è¿›è¡Œæˆæƒåˆ¤æ–­ï¼ˆå¯ä»¥ç¼–å†™ç®€å•çš„é€»è¾‘ï¼‰ã€‚å±æ€§é€šå¸¸æ¥è¯´åˆ†ä¸ºå››ç±»ï¼šç”¨æˆ·å±æ€§ï¼ˆå¦‚ç”¨æˆ·å¹´é¾„ï¼‰ï¼Œç¯å¢ƒå±æ€§ï¼ˆå¦‚å½“å‰æ—¶é—´ï¼‰ï¼Œæ“ä½œå±æ€§ï¼ˆå¦‚è¯»å–ï¼‰å’Œå¯¹è±¡å±æ€§ï¼Œæ‰€ä»¥ç†è®ºä¸Šèƒ½å¤Ÿå®ç°éå¸¸çµæ´»çš„æƒé™æ§åˆ¶ï¼Œå‡ ä¹èƒ½æ»¡è¶³æ‰€æœ‰ç±»å‹çš„éœ€æ±‚ã€‚


## ABACçš„è®¿é—®æ§åˆ¶
åŸºäºABACè®¿é—®æ§åˆ¶éœ€è¦åŠ¨æ€è®¡ç®—å®ä½“çš„å±æ€§ã€æ“ä½œç±»å‹ã€ç›¸å…³çš„ç¯å¢ƒæ¥æ§åˆ¶æ˜¯å¦æœ‰å¯¹æ“ä½œå¯¹è±¡çš„æƒé™ï¼Œæ‰€ä»¥åœ¨è®¾è®¡çš„æ—¶å€™éœ€è¦è€ƒè™‘çš„æ¡ä»¶åˆ¤æ–­çš„çµæ´»æ€§ã€é€šç”¨æ€§ã€æ˜“ç”¨æ€§ï¼Œç”¨æˆ·åªéœ€è¦é€šè¿‡webé¡µé¢å³å¯é…ç½®æˆæƒï¼Œè¿™éœ€è¦å‡å°‘ç¡¬ç¼–ç ä¼¼å¾—é€»è¾‘å˜å¾—ç®€å•é€šç”¨ï¼Œé‚£ä¹ˆè¿™éœ€è¦æ»¡è¶³ä¸€äº›è¿ç®—ç¬¦æ¥å®ç°ã€‚

| ç±»å‹       | è¿ç®—ç¬¦                                       |
| ---------- | -------------------------------------------- |
| ç®—æœ¯è¿ç®—ç¬¦ | +, -, *, /, %, ^, div, mod                   |
| å…³ç³»è¿ç®—ç¬¦ | <, >, ==, !=, <=, >=, lt, gt, eq, ne, le, ge |
| é€»è¾‘è¿ç®—ç¬¦ | and, or, not, &&,   \|\|, !                  |
| æ¡ä»¶       | ?:                                           |


> ä½¿ç”¨åœºæ™¯

ç”¨æˆ·åªéœ€è¦é…ç½® ``user.age > 20`` çš„æ¡ä»¶å³å¯è·å¾—ç‰¹å®šçš„æƒé™ã€‚

## è¡¨è¾¾å¼è¯­è¨€

æ­£å¦‚ä¸Šä¸€èŠ‚æ‰€è¯´çš„éœ€è¦å¯¹æŸç§æ¡ä»¶è¿›è¡Œè§£æé‚£ä¹ˆå°±éœ€è¦è¡¨è¾¾å¼è¯­è¨€ï¼Œè¿™è®©æˆ‘æƒ³èµ·äº†``Spring Framework``çš„``@Value``æ³¨è§£å’Œ`MyBatis`çš„`<if test=â€œâ€>`

```java
// ç›¸ä¿¡å¾ˆå¤š Java boyéƒ½ä½¿ç”¨è¿‡çš„å§
@Value("A?B:C")
private String A;
```

```java
<select id = "XXX">
    <if test="user != null">
        XXXX
    </if>
</select>
```
çœ‹åˆ°è¿™é‡Œå¤§å®¶åº”è¯¥å¤§è‡´çŒœåˆ°äº†ABACçš„çš„æ ¸å¿ƒå°±æ˜¯`Expression Language(EL)`ï¼Œè™½ç„¶ä¸Šé¢çš„ä»£ç æ¼”ç¤ºæ˜¯ä½¿ç”¨Javaç”Ÿæ€ä½œä¸ºæ¼”ç¤ºï¼Œä½†æ˜¯å¯ä»¥å¤§èƒ†çš„ç›¸ä¿¡å…¶ä»–çš„ç¼–ç¨‹è¯­è¨€éƒ½æ˜¯æœ‰ç€è‡ªå·±çš„ELæ¡†æ¶çš„ã€‚

java ELæ¡†æ¶åˆ—è¡¨
- spring-expression
- OGNL
- MVEL
- JBoss EL

è¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†æ„Ÿå…´è¶£å¯ä»¥æŸ¥çœ‹[Java ELç”Ÿæ€æ’å](https://mvnrepository.com/open-source/expression-languages)

## SpELæ€§èƒ½

[Spring Expression Language (SpEL)å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#expressions)


```
// Springå®˜æ–¹æ–‡æ¡£æ‘˜å– ç¿»è¯‘
Spring Framework 4.1 åŒ…å«ä¸€ä¸ªåŸºæœ¬çš„è¡¨è¾¾å¼ç¼–è¯‘å™¨ã€‚è¡¨è¾¾å¼é€šå¸¸è¢«è§£é‡Šï¼Œè¿™åœ¨è¯„ä¼°æœŸé—´æä¾›äº†å¾ˆå¤šåŠ¨æ€çµæ´»æ€§ï¼Œä½†æ²¡æœ‰æä¾›æœ€ä½³æ€§èƒ½ã€‚å¯¹äºå¶å°”çš„è¡¨è¾¾å¼ä½¿ç”¨ï¼Œè¿™å¾ˆå¥½ï¼Œä½†æ˜¯ï¼Œå½“ç”±å…¶ä»–ç»„ä»¶ï¼ˆå¦‚ Spring Integrationï¼‰ä½¿ç”¨æ—¶ï¼Œæ€§èƒ½å¯èƒ½éå¸¸é‡è¦ï¼Œå¹¶ä¸”æ²¡æœ‰çœŸæ­£éœ€è¦åŠ¨æ€æ€§ã€‚

SpEL ç¼–è¯‘å™¨æ—¨åœ¨æ»¡è¶³è¿™ä¸€éœ€æ±‚ã€‚åœ¨æ±‚å€¼æœŸé—´ï¼Œç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ª Java ç±»ï¼Œå®ƒä½“ç°äº†è¿è¡Œæ—¶çš„è¡¨è¾¾å¼è¡Œä¸ºï¼Œå¹¶ä½¿ç”¨è¯¥ç±»æ¥å®ç°æ›´å¿«çš„è¡¨è¾¾å¼æ±‚å€¼ã€‚ç”±äºç¼ºå°‘è¡¨è¾¾å¼å‘¨å›´çš„ç±»å‹ï¼Œç¼–è¯‘å™¨åœ¨æ‰§è¡Œç¼–è¯‘æ—¶ä½¿ç”¨åœ¨è¡¨è¾¾å¼çš„è§£é‡Šè¯„ä¼°æœŸé—´æ”¶é›†çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå®ƒä¸èƒ½çº¯ç²¹ä»è¡¨è¾¾å¼ä¸­çŸ¥é“å±æ€§å¼•ç”¨çš„ç±»å‹ï¼Œä½†åœ¨ç¬¬ä¸€æ¬¡è§£é‡Šè¯„ä¼°æœŸé—´ï¼Œå®ƒä¼šæ‰¾å‡ºå®ƒæ˜¯ä»€ä¹ˆã€‚å½“ç„¶ï¼Œå¦‚æœå„ç§è¡¨è¾¾å¼å…ƒç´ çš„ç±»å‹éšæ—¶é—´å‘ç”Ÿå˜åŒ–ï¼ŒåŸºäºæ­¤ç±»æ´¾ç”Ÿä¿¡æ¯è¿›è¡Œç¼–è¯‘å¯èƒ½ä¼šåœ¨ä»¥åé€ æˆéº»çƒ¦ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œç¼–è¯‘æœ€é€‚åˆå…¶ç±»å‹ä¿¡æ¯åœ¨é‡å¤è®¡ç®—æ—¶ä¸ä¼šæ”¹å˜çš„è¡¨è¾¾å¼ã€‚

è€ƒè™‘ä»¥ä¸‹åŸºæœ¬è¡¨è¾¾å¼ï¼š

someArray[0].someProperty.someOtherProperty < 0.1

ç”±äºå‰é¢çš„è¡¨è¾¾å¼æ¶‰åŠæ•°ç»„è®¿é—®ã€æŸäº›å±æ€§å–æ¶ˆå¼•ç”¨å’Œæ•°å­—æ“ä½œï¼Œå› æ­¤æ€§èƒ½æå‡éå¸¸æ˜¾ç€ã€‚åœ¨ä¸€ä¸ªè¿è¡Œ 50000 æ¬¡è¿­ä»£çš„å¾®å‹åŸºå‡†æµ‹è¯•ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨è§£é‡Šå™¨è¯„ä¼°éœ€è¦ 75 æ¯«ç§’ï¼Œä½¿ç”¨è¡¨è¾¾å¼çš„ç¼–è¯‘ç‰ˆæœ¬ä»…éœ€è¦ 3 æ¯«ç§’ã€‚
```

æœ‰å…³SpELçš„æ€§èƒ½Springå®˜æ–¹æè¿°è¯´SpELçš„æ€§èƒ½å¾ˆæ£’ï¼ˆä¸ªäººæ„Ÿè§‰Springå¯¹è‡ªå·±çš„æµ‹è¯•ç»“æœæ˜¯ä¸æ˜¯å°‘æ‰“äº†ä¸€ä¸ª0å•Šï¼Œ3msçš„æ—¶é—´æœ‰ç‚¹æ— æ³•ç†è§£ï¼‰


# ABACå®è·µ

æœ¬ç« ä»…å®ç°ABACçš„åŸç†ï¼Œä¸ä¼šå¯¹Spring Securityå’Œ Apache Shiroåšä»»ä½•çš„é›†æˆ


å› ä¸ºç¬”è€…æœ¬äººæ˜¯ä¸€ä½Spring boyï¼Œæ‰€ä»¥å·¥ç¨‹é¡¹ç›®ä¼šä»¥Spring Bootæ¡†æ¶ä½œä¸ºåŸºç¡€ï¼Œä½¿ç”¨å…¶å®ƒç¼–ç¨‹è¯­è¨€çš„åŒå­¦å¯èƒ½éœ€è¦å—è‹¦ä¸€ä¸‹äº†ğŸ˜‚, å¤§å®¶çœ‹æ‡‚åŸç†å°±å¯ä»¥äº†ã€‚



- Java 8
- Spring Boot 2.7.6
- MyBatis Plus 3.5.2
- MySQL 8.0

## æ•°æ®åº“è®¾è®¡
![ABAC-UML](../image/abac.png)


| è¡¨å                | ä½œç”¨                           |
|-------------------|------------------------------|
| user              | ç”¨æˆ·è¡¨(ACLå’ŒRBACéƒ½æœ‰è¿™å¼ è¡¨)           |
| user_contribution | ç”¨æˆ·çš„é™„å±ä¿¡æ¯ (ç”¨æˆ·å±æ€§ä¹‹ç±»çš„,ä¸èƒ½ä¸ä¸€å®šåªæœ‰è¿™å¼ è¡¨) |
| permission        | æƒé™è¡¨è¾¾å¼(ACLå’ŒRBACéƒ½æœ‰è¿™å¼ è¡¨)         |
| abac              | rbacè¡¨è¾¾å¼                      |
| abac_permission   | rbacè¡¨è¾¾å¼å’Œæƒé™çš„ç»‘å®šå…³ç³», o2m         |


```sql
# ç”¨æˆ·è¡¨
DROP TABLE if EXISTS user;
CREATE TABLE user (
    id bigint(20) NOT NULL COMMENT 'ä¸»é”®ID',
    name varchar(30) NULL DEFAULT NULL COMMENT 'å§“å',
    age int(11) NULL DEFAULT NULL COMMENT 'å¹´é¾„',
    email varchar(50) NULL DEFAULT NULL COMMENT 'é‚®ç®±',
    PRIMARY KEY (id)
);
# ç”¨æˆ·è¾¹ç¼˜æ•°æ®
DROP TABLE if EXISTS user_contribution;
CREATE TABLE user_contribution (
    id bigint(20) NOT NULL COMMENT 'ä¸»é”®ID',
    user_id bigint(20)  NOT NULL COMMENT 'ç”¨æˆ·è¡¨ID',
    repository varchar(100) NOT NULL COMMENT 'ä»“åº“',
    PRIMARY KEY (id)
);
# æƒé™è¡¨
DROP TABLE if EXISTS permission;
CREATE TABLE permission (
    id bigint(20) NOT NULL COMMENT 'ä¸»é”®ID',
    permission varchar(100) NOT NULL COMMENT 'æƒé™åç§°',
    PRIMARY KEY (id)
);
# abacè¡¨è¾¾å¼è¡¨
DROP TABLE if EXISTS abac;
CREATE TABLE abac (
    id bigint(20) NOT NULL COMMENT 'ä¸»é”®ID',
    expression varchar(100) NOT NULL COMMENT 'abacè¡¨è¾¾å¼',
    PRIMARY KEY (id)
);
# abacè¡¨å’Œæƒé™è¡¨çš„å…³è”è¡¨, o2m
DROP TABLE if EXISTS abac_permission;
CREATE TABLE abac_permission (
    id bigint(20) NOT NULL COMMENT 'ä¸»é”®ID',
    abac_id bigint(20) NOT NULL COMMENT 'abacè¡¨ID',
    permission_id bigint(20) NOT NULL COMMENT 'permissionè¡¨ID',
    PRIMARY KEY (id)
);

```

## javaç¨‹åº

å› ä¸ºç¯‡å¹…é—®é¢˜ï¼Œ åªä¼šä½¿ç”¨å¿…è¦çš„ä»£ç ï¼Œ
ä»£ç æ–‡ä»¶ç»“æ„
```txt
 |src
 | |test
 | | |java
 | | | |plus.wcj.abac.AbacApplicationTests.java  æµ‹è¯•ç±»ä»£ç 
 | |main
 | | |resources
 | | | |application.yml
 | | | |db
 | | | | |schema-h2.sql // DDL
 | | | | |data-h2.sql // DML
 | | |java
 | | | |plus.wcj.abac
 | | | | | | |AbacApplication.java // Spring Bootå¯åŠ¨ç±»
 | | | | | | |security
 | | | | | | | |MetadataCustomizer.java // è‡ªå®šä¹‰userä¿¡æ¯
 | | | | | | | |SecurityContext.java  // Securityä¸Šä¸‹æ–‡
 | | | | | | |entity
 | | | | | | | |Abac.java
 | | | | | | | |User.java
 | | | | | | |dao
 | | | | | | | |UserDao.java
 | | | | | | | |AbacDao.java
 | | | | | | |service
 | | | | | | | |UserService.java
 | | | | | | | |AbacService.java
 |pom.xml
```




### crudä»£ç 


> pom.xml
```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.5.2</version>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>

        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <scope>compile</scope>
        </dependency>
    </dependencies>
```

> entityç±»

```java
/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
@Data
public class Abac {
    private Long id;
    private String expression;

    /** expressionå¯¹åº”çš„permissionsåˆ—è¡¨ */
    @TableField(exist = false)
    private List<String> permissions;
}

@Data
public class User {
    private Long id;
    private String name;
    private Integer age;
    private String email;

    /** ç”¨æˆ·æäº¤è¿‡ä»“åº“ */
    @TableField(exist = false)
    private List<String> contributions = new ArrayList<>();

    /** å­˜æ”¾ä¸€äº›ä¹±ä¸ƒå…«ç³Ÿçš„æ•°æ®ï¼Œå½“ç„¶contributionså­—æ®µä¹Ÿæ”¾åœ¨è¿™é‡Œ */
    @TableField(exist = false)
    private Map<String, Object> metadata = new HashMap<>();
}
```



> daoç±»

```java
/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
@Mapper
public interface AbacDao extends BaseMapper<Abac> {

    /** è·å–abacIdå…³è”æƒé™ */
    @Select("SELECT p.permission\n" +
            "FROM abac_permission ap LEFT JOIN permission p ON p.id = ap.permission_id\n" +
            "WHERE ap.abac_id = #{abacId}")
    List<String> selectPermissions(Long abacId);

}

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
@Mapper
public interface UserDao extends BaseMapper<User> {

    /** è·å–ç”¨æˆ·çš„ä»“åº“ä¿¡æ¯ */
    @Select("SELECT repository FROM user_contribution WHERE user_id = #{userId}")
    List<String> selectRepository(@Param("userId") Long userId);
}

```

> serviceç±»

```java
/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
@Service
@RequiredArgsConstructor
public class AbacService {
    private final AbacDao abacDao;

    /** è·å–abacè¡¨è¾¾å¼è¯¦ç»†ä¿¡æ¯åˆ—è¡¨ */
    public List<Abac> getAll() {
        List<Abac> abacs = abacDao.selectList(null);
        for (Abac abac : abacs) {
            List<String> permissions = abacDao.selectPermissions(abac.getId());
            abac.setPermissions(permissions);
        }
        return abacs;
    }
}


/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
@Service
@RequiredArgsConstructor
public class UserService {
    private final UserDao userDao;

    /** æ ¹æ®userIdè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ */
    public User get(Long userId) {
        User user = userDao.selectById(userId);
        List<String> repository = userDao.selectRepository(userId);
        user.setContributions(repository);
        return user;
    }
}
```

### securityä¸Šä¸‹æ–‡

```java

/**
 * è‡ªå®šä¹‰ç”¨æˆ·å…ƒæ•°æ®  ç”¨äºè·å–ä¸€äº›å®ä½“çš„å±æ€§ã€æ“ä½œç±»å‹ã€ç›¸å…³çš„ç¯å¢ƒ
 *
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
public interface MetadataCustomizer {

    /** è‡ªå®šä¹‰ç”¨æˆ·å…ƒæ•°æ® */
    void customize(User user);
}



/**
 * è§£æabacè¡¨è¾¾å¼
 *
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
@Component
public class SecurityContext {
    /** SpELè¡¨è¾¾å¼è§£æå™¨ */
    private final ExpressionParser expressionParser = new SpelExpressionParser();

    /**
     *  è§£æabacè¡¨è¾¾å¼
     * @param user ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
     * @param abacs abacè¡¨è¾¾å¼è¯¦ç»†ä¿¡æ¯é›†åˆ
     * @return expressionsé›†åˆ, å°†è¿™ä¸ªç»“æœé›†å­˜æ”¾åˆ° Spring Security æˆ–è€…Apache APISIXçš„userDetailä¸Šä¸‹æ–‡ä¸­
     */
    public List<String> rbacPermissions(User user, List<Abac> abacs) {
        return this.rbacPermissions(user, abacs, Collections.emptyList());
    }

    /**
     * è§£æabacè¡¨è¾¾å¼
     * @param user ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
     * @param abacs abacè¡¨è¾¾å¼è¯¦ç»†ä¿¡æ¯é›†åˆ
     * @param metadataCustomizers  è‡ªå®šä¹‰ç”¨æˆ·å…ƒæ•°æ®  ç”¨äºè·å–ä¸€äº›å®ä½“çš„å±æ€§ã€æ“ä½œç±»å‹ã€ç›¸å…³çš„ç¯å¢ƒ
     * @return expressionsé›†åˆ, å°†è¿™ä¸ªç»“æœé›†å­˜æ”¾åˆ° Spring Security æˆ–è€…Apache APISIXçš„userDetailä¸Šä¸‹æ–‡ä¸­
     */
    public List<String> rbacPermissions(User user, List<Abac> abacs, List<MetadataCustomizer> metadataCustomizers) {
        // å¤„ç†è‡ªå®šä¹‰å…ƒæ•°æ®
        metadataCustomizers.forEach(metadataCustomizer -> metadataCustomizer.customize(user));

        List<String> expressions = new ArrayList<>();
        for (Abac abac : abacs) {
            // è§£æè¡¨è¾¾å¼çš„æ±‚å€¼å™¨
            Expression expression = expressionParser.parseExpression(abac.getExpression());
            // åˆ›å»ºç¯å¢ƒä¸Šä¸‹æ–‡
            EvaluationContext context = new StandardEvaluationContext(user);
            // è·å–expressionçš„ç»“æœ
            if (expression.getValue(context, boolean.class)) {
                expressions.addAll(abac.getPermissions());
            }
        }
        return expressions;
    }

}

```


## æµ‹è¯•ç±»




```java

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/11/26
 */
@SpringBootTest
class AbacApplicationTests {

    @Autowired
    private UserService userService;

    @Autowired
    private AbacService abacService;

    @Autowired
    private SecurityContext securityContext;

    /** è·å–ä¸åŒç”¨æˆ·çš„abacæƒé™ */
    @Test
    void testRbac() {
        User user = userService.get(1L);
        List<Abac> rbac = abacService.getAll();
        List<String> permissions = securityContext.rbacPermissions(user, rbac);
        System.out.println(permissions);


        user = userService.get(2L);
        permissions = securityContext.rbacPermissions(user, rbac);
        System.out.println(permissions);

        user = userService.get(3L);
        permissions = securityContext.rbacPermissions(user, rbac);
        System.out.println(permissions);


    }

    /**
     * è·å–è‡ªå®šä¹‰æƒé™
     */
    @Test
    void testMetadataCustomizer() {
        User user = userService.get(1L);
        List<Abac> rbac = abacService.getAll();

        List<String> permissions = securityContext.rbacPermissions(user, rbac);
        System.out.println(permissions);

        permissions = securityContext.rbacPermissions(user, rbac, getMetadataCustomizer());
        System.out.println(permissions);
    }

    /** æ¨¡æ‹Ÿç½‘ç»œip */
    private List<MetadataCustomizer> getMetadataCustomizer() {
        return new ArrayList<MetadataCustomizer>() {{
            add(user -> user.getMetadata().put("ip", "192.168.0.1"));
        }};
    }
}

```

```sql
DELETE FROM user;
INSERT INTO user (id, name, age, email)
VALUES (1, 'é­æ˜Œè¿›', 26, 'mail@wcj.plus'),
       (2, 'test', 1, 'mail1@wcj.plus'),
       (3, 'admin', 1, 'mail2@wcj.plus');

DELETE FROM user_contribution;
INSERT INTO user_contribution (id, user_id, repository)
VALUES (1, 1, 'galaxy-sea/spring-cloud-apisix'),
       (2, 2, 'spring-cloud/spring-cloud-commons'),
       (3, 2, 'spring-cloud/spring-cloud-openfeign'),
       (4, 2, 'alibaba/spring-cloud-alibaba'),
       (5, 2, 'Tencent/spring-cloud-tencent'),
       (6, 2, 'apache/apisix-docker');

DELETE FROM permission;
INSERT INTO permission (id, permission)
VALUES (1, 'github:pr:merge'),
       (2, 'github:pr:close'),
       (3, 'github:pr:open'),
       (4, 'github:pr:comment');


DELETE FROM abac;
INSERT INTO abac (id, expression)
VALUES (1, 'contributions.contains(''galaxy-sea/spring-cloud-apisix'')'),
       (2, 'name == ''admin'''),
       (3, 'metadata.get(''ip'') == ''192.168.0.1''');

DELETE FROM abac_permission;
INSERT INTO abac_permission (id, abac_id, permission_id)
VALUES (1, 1, 1),

       (2, 2, 1),
       (3, 2, 2),
       (4, 2, 3),
       (5, 2, 4),

       (6, 3, 1),
       (7, 3, 2),
       (8, 3, 3),
       (9, 3, 4);
```


# Spring Security å’Œ Apache Shiroæ•´åˆ
Spring Securityåªéœ€è¦ä¿®æ”¹æ‹¦æˆªå™¨å³å¯åœ¨è·å–åˆ°``UserDetails``å°†``SecurityContext#rbacPermissions``è½¬æ¢ä¸º``GrantedAuthority``å³å¯

```java
/**
 * è¿™é‡Œæ˜¯ä¼ªä»£ç ï¼Œ å±•ç¤ºä¸€ä¸‹å¤§æ¦‚é€»è¾‘
 *
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/04/29
 */
public class IamOncePerRequestFilter implements OncePerRequestFilter {

  @Autowired
  private SecurityContext securityContext;

  @Autowired
  private AbacService abacService;

  @Autowired
  private List<MetadataCustomizer> metadataCustomizers;

  @Autowired
  public void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) {
    UserDetails user = toUser();
    List<String> permissions = securityContext.rbacPermissions(user, abacService.getAll(), metadataCustomizers);
    List<GrantedAuthority> abacAuthority = permissions.stream().map(SimpleGrantedAuthority::new).collect(Collectors.toList());
    user.getAuthorities().addAll(abacAuthority);
  }
}

```