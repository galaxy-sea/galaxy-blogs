```text
/*
* Copyright 2021-2022 the original author or authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
  */
```

<!-- TOC -->

- [Spring Security æ‹¦æˆªé—®é¢˜](#spring-security-æ‹¦æˆªé—®é¢˜)
- [ä¸€ä¸ªæ³¨è§£æå®šSpring Security å¿½ç•¥æ‹¦æˆª](#ä¸€ä¸ªæ³¨è§£æå®šspring-security-å¿½ç•¥æ‹¦æˆª)
  - [åŸºäºæ³¨è§£å½¢å¼](#åŸºäºæ³¨è§£å½¢å¼)
  - [åŸºäºé…ç½®å½¢å¼](#åŸºäºé…ç½®å½¢å¼)
- [æ€»ç»“](#æ€»ç»“)

<!-- /TOC -->


>æºç åœ°å€ [galaxy-sea/galaxy-blogs/code/security-annotation](https://github.com/galaxy-sea/galaxy-blogs/tree/master/code/security-annotation)   
>æºç åœ°å€ [galaxy-sea/galaxy-blogs/code/security-annotation](https://github.com/galaxy-sea/galaxy-blogs/tree/master/code/security-annotation)   
>æºç åœ°å€ [galaxy-sea/galaxy-blogs/code/security-annotation](https://github.com/galaxy-sea/galaxy-blogs/tree/master/code/security-annotation)


# Spring Security æ‹¦æˆªé—®é¢˜

Spring Securityæ˜¯å¹²å•¥çš„æˆ‘å°±ä¸æƒ³è§£é‡Šäº†, æ¯•ç«Ÿç™¾åº¦ä¸Šé¢çš„è®²è§£ä¸€å¤§å †è§£è¯´çš„å¯æ˜¯ä¼šæ¯”æˆ‘ç»†è‡´ğŸ˜„ã€‚

å¼€å‘çš„æ—¶å€™æˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹éƒ¨åˆ†çš„@RequestMappingè®¾ç½®ä¸º public api ä¸éœ€è¦ç™»é™†ä¹Ÿå¯ä»¥è®¿é—®å¦‚ç™»é™†æ¥å£ç­‰ç­‰ã€‚åçˆ±Springæ³¨è§£ç¼–ç¨‹ï¼Œé‚£æˆ‘ä»¬å°±åŸºäºæ³¨è§£çš„æ–¹å¼æ¥å¿½ç•¥Spring Securityçš„æ‹¦æˆªå§ã€‚

```java
public class SecurityConfigurer extends WebSecurityConfigurerAdapter {
  WebSecurity.IgnoredRequestConfigurer ignoring = web.ignoring();
     ignoring.antMatchers("/login");
     ignoring.antMatchers("/public api...");
}
```

å°±å¦‚æˆ‘ä»¬ä¸Šé¢ä»£ç å±•ç¤ºçš„ä¸€æ ·ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹Spring Securityçš„å¿½ç•¥åå•è¿›è¡Œç¡¬ç¼–ç é…ç½®æˆ–è€…é…ç½®æ–‡ä»¶é…ç½®æˆ‘éƒ½æ„Ÿè§‰æŒºç¹ççš„ï¼ŒSpringéƒ½å·²ç»æå€¡åŸºäºæ³¨è§£ç¼–ç¨‹äº†ï¼Œç™¾åº¦åˆ°çš„å†…å®¹å±…ç„¶è¿˜æ˜¯æ•™æˆ‘ç”¨ç¡¬ç¼–ç æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°±åŸºäºæ³¨è§£æ¥å®ç°Spring Securityå¿½ç•¥æ‹¦æˆªçš„å®ç°å§ã€‚

#  ä¸€ä¸ªæ³¨è§£æå®šSpring Security å¿½ç•¥æ‹¦æˆª
æœ¬ç« èŠ‚æˆ‘ä»¬å°±ç”¨æ³¨è§£çš„æ–¹å¼æ¥å®ç°Spring Securityå¿½ç•¥æ‹¦æˆªå§ã€‚æœ¬ç« ä¼šåˆ†åˆ«ä»‹ç»åŸºäºæ³¨è§£æ–¹å¼å’Œé…ç½®æ–‡ä»¶æ–¹å¼
- æ³¨è§£ä¸»è¦é’ˆå¯¹@RequestMappingè¿›è¡Œå¿½ç•¥
- é…ç½®æ–‡ä»¶ä¸»è¦é’ˆå¯¹é™æ€æ–‡ä»¶ï¼ˆjsï¼Œhtmlï¼Œcssï¼Œ...ï¼‰è¿›è¡Œå¿½ç•¥

> ç¯å¢ƒé…ç½®

- Spring Boot 2.5.X
  - Spring MVC
  - Spring Security
  - lombok
- Java 1.8

> å› ä¸ºæ˜¯å•çº¯çš„æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åŸºäºæ³¨è§£å¿½ç•¥Spring Securityæ‹¦æˆªï¼Œæ‰€ä»¥åªä¼šä½¿ç”¨æœ€å°demoè€Œä¸æ˜¯å¤§ç¯‡é•¿è®ºçš„å»é­”æ”¹Spring Securityï¼ˆå…¶å®æ˜¯æˆ‘æ‡’å¾—å†™å•¦åæ­£ç™¾åº¦éƒ½æœ‰ğŸ˜„ï¼‰  
> è€è§„çŸ©ä¸‹é¢ç›´æ¥æ”¾ä»£ç å§ã€‚

ä»£ç å°±éœ€è¦å¤§å®¶å»[start.spring.io](https://start.spring.io/)ç”Ÿæˆä¸€ä¸‹å•¦ï¼Œç„¶åæ”¹ä¸€ä¸‹Spring Bootçš„ç‰ˆæœ¬å·ï¼Œæˆ–è€…å»æˆ‘çš„GitHubç›´æ¥cloneä»£ç ï¼š [galaxy-sea/galaxy-blogs](https://github.com/galaxy-sea/galaxy-blogs/tree/master/code/security-annotation)

> SecurityConfiguration é…ç½®ç±»
```java
@Configuration
@EnableWebSecurity
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

  @Override
  public void configure(WebSecurity web) {
    WebSecurity.IgnoredRequestConfigurer ignoring = web.ignoring();
    ignoring.antMatchers(HttpMethod.GET, "/hello/hardcode");
  }
}
```

> HelloControllerç”¨äºæµ‹è¯•Spring Securityæ‹¦æˆªå™¨

```java

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/12/15
 */
@RestController
@RequestMapping("hello")
public class HelloController {

  @GetMapping("/security")
  public String security(){
    return "Hello, Security";
  }

  @GetMapping("/hardcode")
  public String hardcode(){
    return "Hello, hardcode";
  }
}
```

> æµ‹è¯•ç»“æœ

```shell
# æµ‹è¯•ç»“æœ1
curl http://127.0.0.1:8080/hello/security -i
HTTP/1.1 401 
Content-Type: application/json

{"timestamp":"2022-12-16T10:54:44.403+00:00","status":401,"error":"Unauthorized","path":"/hello/security"}

# æµ‹è¯•ç»“æœ2
curl http://127.0.0.1:8080/hello/hardcode -i
HTTP/1.1 200 
Content-Type: text/plain;charset=UTF-8

Hello, hardcod
```



## åŸºäºæ³¨è§£å½¢å¼

å…¶å®ç¡¬ç¼–ç è¿™ç§å¤„ç†æ–¹å¼å¦‚æœpublic apiè¾ƒå°‘çš„æƒ…å†µä¸‹è¿˜æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯public apiå˜å¤šäº†å°±ä¸æ˜¯å¾ˆå‹å¥½äº†ã€‚  
é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å°±åŸºäºæ³¨è§£çš„å½¢å¼å®ç°ä¸€ä¸‹å§ï¼Œä»£ç é‡åŠå…¶ç²¾ç®€çš„å“¦ã€‚

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª``IgnoreWebSecurity``æ³¨è§£ç”¨æˆ·å°†apiè®¾ç½®ä¸ºpublic api, ç„¶åæˆ‘ä»¬æ”¹é€ ä¸€ä¸‹``SecurityConfiguration``ç±»ã€‚

> IgnoreWebSecurity

```java
import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Inherited;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/1/3
 */
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Documented
public @interface IgnoreWebSecurity {
}
```


> æ”¹é€  SecurityConfiguration

```java

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/12/15
 */
@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {


  private final RequestMappingHandlerMapping requestMappingHandlerMapping;


  @Override
  public void configure(WebSecurity web) {
    WebSecurity.IgnoredRequestConfigurer ignoring = web.ignoring();
    ignoring.antMatchers(HttpMethod.GET, "/hello/hardcode");
    this.ignoreAnnotation(ignoring, this.requestMappingHandlerMapping);
  }

  private void ignoreAnnotation(WebSecurity.IgnoredRequestConfigurer ignoring, RequestMappingHandlerMapping requestMappingHandlerMapping) {
    Map<RequestMappingInfo, HandlerMethod> handlerMethods = requestMappingHandlerMapping.getHandlerMethods();
    for (Map.Entry<RequestMappingInfo, HandlerMethod> entry : handlerMethods.entrySet()) {
      HandlerMethod handlerMethod = entry.getValue();
      if (handlerMethod.hasMethodAnnotation(IgnoreWebSecurity.class)) {
        Set<String> patternValues = entry.getKey().getPatternValues();
        Set<RequestMethod> methods = entry.getKey().getMethodsCondition().getMethods();
        if (CollectionUtils.isEmpty(methods)) {
          // RequestMappingæ²¡æœ‰æŒ‡å®šmethod
          ignoring.antMatchers(patternValues.toArray(new String[0]));
        } else {
          for (RequestMethod method : methods) {
            // RequestMappingæŒ‡å®šäº†method
            ignoring.antMatchers(HttpMethod.resolve(method.name()), patternValues.toArray(new String[0]));
          }
        }
      }
    }
  }
}
```


> HelloController å¢åŠ ä¸€ä¸‹æµ‹è¯•æ–¹æ³•

```java
/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/12/15
 */
@RestController
@RequestMapping("hello")
public class HelloController {

  /** æ³¨è§£æ–¹å¼ */
  @GetMapping("/annotation")
  @IgnoreWebSecurity
  public String annotation() {
    return "Hello, annotation";
  }


  /** æµ‹è¯•PathVariableå‚æ•° */
  @GetMapping("/{path}/annotation")
  @IgnoreWebSecurity
  public String annotationPath(@PathVariable String path) {
    return "Hello, annotation. path: " + path;
  }
}
```


> æµ‹è¯•ç»“æœ

```shell
# æµ‹è¯•æ³¨è§£
curl http://127.0.0.1:8080/hello/annotation -i
HTTP/1.1 200 
Content-Type: text/plain;charset=UTF-8
Content-Length: 17
Date: Sun, 18 Dec 2022 12:25:05 GMT

Hello, annotatio


# æµ‹è¯•æ³¨è§£
curl http://127.0.0.1:8080/hello/public_api/annotation -i
HTTP/1.1 200 
Content-Type: text/plain;charset=UTF-8
Content-Length: 35
Date: Sun, 18 Dec 2022 12:25:35 GMT

Hello, annotation. path: public_api
```


é€šè¿‡è§£æ``RequestMappingHandlerMapping``æˆ‘ä»¬å°±å¯ä»¥å°†apiè®¾ç½®ä¸ºpublic apiäº†ã€‚è¿™ç§æ–¹å¼å¤§å¤§ç®€ä¾¿çš„é…ç½®ã€‚



## åŸºäºé…ç½®å½¢å¼
ä¸Šä¸€ç« æˆ‘ä»¬é€šè¿‡æ³¨è§£çš„æ–¹å¼å»å°†apiè®¾ç½®ä¸ºpublic apiä½†æ˜¯è¿™ç§æ–¹å¼å¯¹é™æ€èµ„æºï¼ˆhtmlï¼Œjsï¼Œcssç­‰ï¼‰å¹¶ä¸æ˜¯å¾ˆå‹å¥½ï¼Œå¥½éœ€è¦é€šè¿‡é…ç½®çš„æ–‡ä»¶çš„æ–¹å¼å°†ä¸€äº›é™æ€èµ„æºè®¾ç½®ä¸ºpublicï¼Œæ‰€ä»¥æœ¬ç« èŠ‚é€šè¿‡é…ç½®æ–‡ä»¶æ–¹å¼æ¥å®ç°public apiçš„å¿½ç•¥æ‹¦æˆª

åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶``IgnoreWebSecurityProperties``æ¥é…ç½®

> IgnoreWebSecurityProperties

```java

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/12/15
 */
@Data
@ConfigurationProperties(prefix = "security.ignoring")
public class IgnoreWebSecurityProperties {
  /** éœ€è¦å¿½ç•¥çš„ URL æ ¼å¼ï¼Œä¸è€ƒè™‘è¯·æ±‚æ–¹æ³• */
  private String[] pattern = {};

  /** éœ€è¦å¿½ç•¥çš„ GET è¯·æ±‚ */
  private String[] get = {};

  /**  éœ€è¦å¿½ç•¥çš„ POST è¯·æ±‚ */
  private String[] post = {};

  /**  éœ€è¦å¿½ç•¥çš„ DELETE è¯·æ±‚ */
  private String[] delete = {};

  /**  éœ€è¦å¿½ç•¥çš„ PUT è¯·æ±‚ */
  private String[] put = {};

  /** éœ€è¦å¿½ç•¥çš„ HEAD è¯·æ±‚ */
  private String[] head = {};

  /** éœ€è¦å¿½ç•¥çš„ PATCH è¯·æ±‚ */
  private String[] patch = {};

  /** éœ€è¦å¿½ç•¥çš„ OPTIONS è¯·æ±‚ */
  private String[] options = {};

  /** éœ€è¦å¿½ç•¥çš„ TRACE è¯·æ±‚ */
  private String[] trace = {};
}
```
> æ”¹é€  IgnoreWebSecurityProperties

```java

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/12/15
 */
@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
@EnableConfigurationProperties(IgnoreWebSecurityProperties.class)
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

  private final IgnoreWebSecurityProperties ignoreWebSecurityProperties;
  private final RequestMappingHandlerMapping requestMappingHandlerMapping;

  @Override
  public void configure(WebSecurity web) {
    WebSecurity.IgnoredRequestConfigurer ignoring = web.ignoring();
    ignoring.antMatchers(HttpMethod.GET, "/hello/hardcode");
    this.ignoreAnnotation(ignoring, this.requestMappingHandlerMapping);
    this.ignoreProperties(ignoring, this.ignoreWebSecurityProperties);
  }
    ...
  private void ignoreProperties(WebSecurity.IgnoredRequestConfigurer ignoring, IgnoreWebSecurityProperties ignoreWebSecurityProperties) {
    ignoring.antMatchers(HttpMethod.GET, ignoreWebSecurityProperties.getGet())
            .antMatchers(HttpMethod.POST, ignoreWebSecurityProperties.getPost())
            .antMatchers(HttpMethod.DELETE, ignoreWebSecurityProperties.getDelete())
            .antMatchers(HttpMethod.PUT, ignoreWebSecurityProperties.getPut())
            .antMatchers(HttpMethod.HEAD, ignoreWebSecurityProperties.getHead())
            .antMatchers(HttpMethod.PATCH, ignoreWebSecurityProperties.getPatch())
            .antMatchers(HttpMethod.OPTIONS, ignoreWebSecurityProperties.getOptions())
            .antMatchers(HttpMethod.TRACE, ignoreWebSecurityProperties.getTrace())
            .antMatchers(ignoreWebSecurityProperties.getPattern());
  }
}

```

> æ”¹é€ HelloController
```java
/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/12/15
 */
@RestController
@RequestMapping("hello")
public class HelloController {
  /** æµ‹è¯•PathVariableå‚æ•° */
  @GetMapping("/properties")
  @IgnoreWebSecurity
  public String properties(){
    return "Hello, properties";
  }

  /** æµ‹è¯•PathVariableå‚æ•° */
  @GetMapping("/{path}/properties")
  @IgnoreWebSecurity
  public String propertiesPath(@PathVariable String path){
    return "Hello, properties. path: " + path;
  }
}
```


> application.yml
```yaml
security:
  ignoring:
    get:
      - /hello/{path}/properties
```

> æµ‹è¯•ç»“æœ

```shell
# é…ç½®æ–‡ä»¶æµ‹è¯•
curl http://127.0.0.1:8080/hello/properties -i
HTTP/1.1 200 
Content-Type: text/plain;charset=UTF-8
Content-Length: 17
Date: Sun, 18 Dec 2022 12:35:14 GMT

Hello, properties

# é…ç½®æ–‡ä»¶æµ‹è¯•
curl http://127.0.0.1:8080/hello/public_api/properties -i
HTTP/1.1 200 
Content-Type: text/plain;charset=UTF-8
Content-Length: 35
Date: Sun, 18 Dec 2022 12:36:01 GMT

Hello, properties. path: public_api
```

# æ€»ç»“

å…¶å®æ— è®ºæ˜¯ä»‹äºæ³¨è§£æ–¹å¼è¿˜æ˜¯é…ç½®æ–‡ä»¶æ–¹å¼éƒ½å„æœ‰ä¼˜ç¼ºç‚¹çœ‹å¤§å®¶æ˜¯å¦çš„é€‰æ‹©äº†ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘ä»£ç ç¡¬ç¼–ç çš„é—®é¢˜ã€‚
