# knife4j(Swagger) çš„äºŒæ¬¡å°è£…
æˆ‘æ˜¯ä¸€ä¸ªä¸çˆ±è¯´è¯çš„å®…ç”·, ç»å¸¸å› ä¸ºæ¥å£é—®é¢˜éœ€è¦è¢«è¿«å’Œå‰ç«¯äº¤æµ, è™½ç„¶ knife4j(Swagger) èƒ½å¤Ÿç”ŸæˆAPIæ–‡æ¡£, ä½†æ˜¯ç»å¸¸ä¼šå‡ºç°ä¸€äº›æ²Ÿé€šä¸Šé¢çš„é—®é¢˜å¦‚
- XXX api æ¥å£çš„æƒé™æ˜¯ä»€ä¹ˆ
- è¿™ä¸ªæ¥å£æ”¯æŒé‚£äº›æ’åº
- XXXå¯¹è±¡çš„å‚æ•°å¤ªå¤šäº†,èƒ½ä¸èƒ½ä¸è¦å…¨éƒ¨ç»™æˆ‘å•Š, ç‰¹åˆ«æ˜¯ä½ çš„åˆ†é¡µå¯¹è±¡
- ......

> â€œTalk is cheap. Show me the code.â€ â€• Linus Torvalds
> ç‰¹åˆ«å–œæ¬¢è¿™å¥è¯, æ‰€ä»¥å°±æ”¾åœ¨è¿™é‡Œäº†ğŸ˜¬. ä¸‹æ–¹éƒ½æ˜¯ä»£ç copyå°±èƒ½ç”¨
> 
> è¯¦ç»†ä»£ç è¯¦è§GitHub [https://github.com/galaxy-sea/galaxy-blogs/tree/master/code/swagger-support](https://github.com/galaxy-sea/galaxy-blogs/tree/master/code/swagger-support)

Swagger æä¾›``springfox.documentation.spi.service.OperationBuilderPlugin``è®©æˆ‘ä»¬å¯¹``springfox.documentation.spi.service.contexts.OperationContext``è¿›è¡Œè¿›è¡Œä¸€äº›è‡ªå®šä¹‰å¯¹å°è£….

å¼€å‘ç¯å¢ƒé…ç½®
- jdk 17
- knife4j 3.0.3
- Spring Boot 2.7.7
  - Spring Security
- mybatis plus 3.5.2


# Spring Security æ³¨è§£å±•ç¤º
å°†Spring Securityçš„`PostAuthorize`ã€`PostFilter`ã€`PreAuthorize`ã€`PreFilter`çš„æ³¨è§£ä¿¡æ¯è¿½åŠ åˆ°æ¥å£æè¿°ä¸­.

```java

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/12/27
 */
@Order(SwaggerPluginSupport.OAS_PLUGIN_ORDER + 100)
@Component
public class SecurityAnnotationOperationBuilderPlugin implements OperationBuilderPlugin {

    private static final String PACKAGE_PREFIX = "org.springframework.security.access.prepost.";

    @Override
    public void apply(OperationContext context) {
        String notes = context.operationBuilder().build().getNotes();
        StringBuffer notesBuffer = new StringBuffer(notes == null ? "" : notes);
        getClassAnnotationNote(notesBuffer, context);
        getMethodAnnotationNote(notesBuffer, context);
        context.operationBuilder().notes(notesBuffer.toString());
    }


    @Override
    public boolean supports(DocumentationType delimiter) {
        return true;
    }

    private void getClassAnnotationNote(StringBuffer notesBuffer, OperationContext context) {
        StringBuffer securityNotes = new StringBuffer();
        context.findControllerAnnotation(PostAuthorize.class)
               .ifPresent(ann -> append(securityNotes, ann));
        context.findControllerAnnotation(PostFilter.class)
               .ifPresent(ann -> append(securityNotes, ann));
        context.findControllerAnnotation(PreAuthorize.class)
               .ifPresent(ann -> append(securityNotes, ann));
        context.findControllerAnnotation(PreFilter.class)
               .ifPresent(ann -> append(securityNotes, ann));
        if (securityNotes.length() > 0) {
            notesBuffer.append("<p />");
            notesBuffer.append("class: ");
            notesBuffer.append(securityNotes);
        }
    }

    private void getMethodAnnotationNote(StringBuffer notesBuffer, OperationContext context) {
        StringBuffer securityNotes = new StringBuffer();
        context.findAnnotation(PostAuthorize.class)
               .ifPresent(ann -> append(securityNotes, ann));
        context.findAnnotation(PostFilter.class)
               .ifPresent(ann -> append(securityNotes, ann));
        context.findAnnotation(PreAuthorize.class)
               .ifPresent(ann -> append(securityNotes, ann));
        context.findAnnotation(PreFilter.class)
               .ifPresent(ann -> append(securityNotes, ann));
        if (securityNotes.length() > 0) {
            notesBuffer.append("<p />");
            notesBuffer.append("method: ");
            notesBuffer.append(securityNotes);
        }
    }

    private void append(StringBuffer securityNotes, Annotation ann) {
        String txt = ann.toString().replace(PACKAGE_PREFIX, "").replace("\\'", "'");
        securityNotes.append(txt)
                     .append(" ");
    }

}
```

# MyBatis Plus

## orderBy å‚æ•°å±•ç¤º
å±•ç¤ºmybatis plus pageå¯¹è±¡æ”¯æŒçš„æ’åºçš„å­—æ®µ

```java
/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/8/12
 */
@Component
@Order(SwaggerPluginSupport.OAS_PLUGIN_ORDER + 101)
public class OrderByFieldsOperationBuilderPlugin implements OperationBuilderPlugin {
    @Override
    public void apply(OperationContext context) {
        List<ResolvedMethodParameter> parameters = context.getParameters();

        for (ResolvedMethodParameter resolvedMethodParameter : parameters) {
            Class<?> erasedType = resolvedMethodParameter.getParameterType().getErasedType();
            if (IPage.class.isAssignableFrom(erasedType)) {
                List<String> orderItems = this.toOrderItems(resolvedMethodParameter);
                if (!CollectionUtils.isEmpty(orderItems)) {
                    this.joinNotes(orderItems, context);
                }
                return;
            }
        }
    }

    @SuppressWarnings("NullableProblems")
    @Override
    public boolean supports(DocumentationType delimiter) {
        return true;
    }

    private void joinNotes(List<String> orderItems, OperationContext context) {
        StringBuilder order = new StringBuilder();
        order.append("OrderBy: ");
        for (String orderItem : orderItems) {
            order.append(orderItem).append(" ");
        }
        String notes = context.operationBuilder().build().getNotes();

        notes = StringUtils.hasText(notes) ? notes + "<p />" + order : order.toString();
        context.operationBuilder().notes(notes);
    }


    private List<String> toOrderItems(ResolvedMethodParameter resolvedMethodParameter) {
        ResolvedType boundType = resolvedMethodParameter.getParameterType().getTypeBindings().getBoundType(0);
        if (boundType == null) {
            return List.of();
        }
        Class<?> orderClass = boundType.getErasedType();
        return TableInfoHelper.getAllFields(orderClass)
                              .stream()
                              .map(Field::getName)
                              .toList();
    }
}
```


## å¿½ç•¥ä¸å¿…è¦åœ°è¯·æ±‚å‚æ•°
è¿™ä¸ªåŠŸèƒ½æ˜¯ä»…æ”¯æŒknife4jä¸æ”¯æŒSwagger, 
ç»å¸¸å› ä¸ºçœ‹ç€pageå¯¹è±¡ä¸€å¤§ä¸²ä¸éœ€è¦çš„å­—æ®µè€Œçƒ¦æ¼ç€, è¿™é‡Œæˆ‘ä»¬å°±å°†ä¸éœ€è¦çš„å­—æ®µç»™å¿½ç•¥æ‰, ä»…ä¿ç•™``current``, ``size``, ``orders[].asc``, ``orders[0].column``è¿™æ˜¯ä¸ªå­—æ®µ.

```java

/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/8/12
 */
@Component
@Order(SwaggerPluginSupport.OAS_PLUGIN_ORDER + 101)
public class OrderByFieldsOperationBuilderPlugin implements OperationBuilderPlugin {
    @Override
    public void apply(OperationContext context) {
        List<ResolvedMethodParameter> parameters = context.getParameters();

        for (ResolvedMethodParameter resolvedMethodParameter : parameters) {
            Class<?> erasedType = resolvedMethodParameter.getParameterType().getErasedType();
            if (IPage.class.isAssignableFrom(erasedType)) {
                List<String> orderItems = this.toOrderItems(resolvedMethodParameter);
                if (!CollectionUtils.isEmpty(orderItems)) {
                    this.joinNotes(orderItems, context);
                }
                return;
            }
        }
    }

        @SuppressWarnings("NullableProblems")
    @Override
    public boolean supports(DocumentationType delimiter) {
        return true;
    }

    private void joinNotes(List<String> orderItems, OperationContext context) {
        StringBuilder order = new StringBuilder();
        order.append("OrderBy: ");
        for (String orderItem : orderItems) {
            order.append(orderItem).append(" ");
        }
        String notes = context.operationBuilder().build().getNotes();

        notes = StringUtils.hasText(notes) ? notes + "<p />" + order : order.toString();
        context.operationBuilder().notes(notes);
    }


    private List<String> toOrderItems(ResolvedMethodParameter resolvedMethodParameter) {
        ResolvedType boundType = resolvedMethodParameter.getParameterType().getTypeBindings().getBoundType(0);
        if (boundType == null) {
            return List.of();
        }
        Class<?> orderClass = boundType.getErasedType();
        return TableInfoHelper.getAllFields(orderClass)
                              .stream()
                              .map(Field::getName)
                              .toList();
    }
}
```

# å±•ç¤ºç»“æœå¯¹æ¯”
## æµ‹è¯•ä»£ç 
```java
/**
 * @author changjin wei(é­æ˜Œè¿›)
 * @since 2022/12/27
 */
@RestController
@RequestMapping("/hello")
@PostAuthorize("hasAuthority('class')")
@PostFilter("hasAuthority('class')")
@PreAuthorize("hasAuthority('class')")
@PreFilter("hasAuthority('class')")
public class HelloController {

    @GetMapping("/security")
    @PostAuthorize("hasAuthority('method')")
    @PostFilter("hasAuthority('method')")
    @PreAuthorize("hasAuthority('method')")
    @PreFilter("hasAuthority('method')")
    @ApiOperation(value = "", notes = "Spring Securityæ³¨è§£è¿½åŠ åˆ°æ¥å£æè¿°")
    public String security() {
        return "hello security";
    }
    @SuppressWarnings("unused")
    @GetMapping("/page")
    @ApiOperationSupport(ignoreParameters = {"current",})
    public String page(Page<Object> page) {
        return "hello page";
    }
    @SuppressWarnings("unused")
    @GetMapping("/orderBy")
    public String orderBy(Page<User> page) {
        return "hello orderBy";
    }
}

@TableName
@Data
public class User {
    private String id;
    private String name;
    private String age;
    private String sex;
    private String company;
    private String job;
}

```
## ç»“æœå¯¹æ¯”
1. Spring Security
![security.png](images%2Fsecurity.png)
2. mybatis plus æ’åºå­—æ®µ
![orderBy.png](images%2ForderBy.png)
3. mybatis plus å¿½ç•¥ä¸å¿…è¦çš„å­—æ®µ
![PageIgnore.png](images%2FPageIgnore.png)

# åè®°
å…¶å®è¿™äº›åŠŸèƒ½å¾ˆä¹…ä»¥å‰å°±å†™å®Œäº†, ä¸€ç›´æ”¾åœ¨æˆ‘çš„[heifer](https://github.com/galaxy-sea/heifer)ä¸­, ä½†æ˜¯heiferç›®å‰å°±å‡ å®¶å…¬å¸åœ¨ç”¨. æ‰€ä»¥æ¸æ¸çš„å°†heiferæ¡†æ¶ä¸­çš„ä¸€äº›åŠŸèƒ½å‰¥ç¦»å‡ºæ¥å•ç‹¬å‘åšå®¢.

é¡ºå¸¦æä¸€ä¸‹åœ¨æˆ‘å†™è¿™ç¯‡åšå®¢çš„åšå®¢çš„æ—¶å€™Spring Securityçš„åŠŸèƒ½å·²ç»æäº¤ç»™äº† [knife4j](https://github.com/xiaoymin/swagger-bootstrap-ui) å¹¶åˆå¹¶è¿›å»äº†, è¯¦è§ [PR 520](https://github.com/xiaoymin/swagger-bootstrap-ui/pull/520) 
